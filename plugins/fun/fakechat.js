const config = require('../../config')

const pluginConfig = {
    name: 'fakechat',
    alias: ['fc', 'fakewa', 'fakemsg'],
    category: 'fun',
    description: 'Generate fake WhatsApp chat',
    usage: '.fakechat @user | pesan',
    example: '.fakechat @user | Kamu ganteng banget!',
    isOwner: false,
    isPremium: false,
    isGroup: false,
    isPrivate: false,
    cooldown: 10,
    limit: 1,
    isEnabled: true
}

async function handler(m, { sock }) {
    const input = m.fullArgs?.trim() || m.text?.trim()
    
    if (!input || !input.includes('|')) {
        return m.reply(
            `ğŸ’¬ *Ò“á´€á´‹á´‡ á´„Êœá´€á´›*\n\n` +
            `> Generate fake WhatsApp chat!\n\n` +
            `â•­â”ˆâ”ˆâ¬¡ã€Œ ğŸ“‹ *Ò“á´Ê€á´á´€á´›* ã€\n` +
            `â”ƒ .fakechat @user | pesan\n` +
            `â•°â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ¬¡\n\n` +
            `*Contoh:*\n` +
            `> .fakechat @user | Kamu ganteng!\n` +
            `> .fakechat 628xxx | Hai sayang ğŸ’•\n\n` +
            `*Multi pesan:*\n` +
            `> .fakechat @user | pesan1 ; pesan2 ; pesan3`
        )
    }
    
    let target = m.mentionedJid?.[0] || m.quoted?.sender
    let messagesPart = ''
    
    const parts = input.split('|')
    if (parts.length < 2) {
        return m.reply(`âŒ Format salah! Gunakan: .fakechat @user | pesan`)
    }
    
    const targetPart = parts[0].trim()
    messagesPart = parts.slice(1).join('|').trim()
    
    if (!target) {
        const numMatch = targetPart.match(/(\d{10,15})/)
        if (numMatch) {
            target = numMatch[1] + '@s.whatsapp.net'
        }
    }
    
    if (!target) {
        return m.reply(`âŒ Target tidak valid! Tag user atau masukkan nomor.`)
    }
    
    if (!messagesPart) {
        return m.reply(`âŒ Pesan tidak boleh kosong!`)
    }
    
    const messages = messagesPart.split(';').map(msg => msg.trim()).filter(Boolean)
    
    if (messages.length === 0) {
        return m.reply(`âŒ Pesan tidak boleh kosong!`)
    }
    
    if (messages.length > 10) {
        return m.reply(`âŒ Maksimal 10 pesan!`)
    }
    
    let targetName = ''
    try {
        const contact = await sock.onWhatsApp(target.split('@')[0])
        if (contact?.[0]?.exists) {
            targetName = target.split('@')[0]
        }
    } catch {}
    
    if (!targetName) {
        targetName = target.split('@')[0]
    }
    
    let ppUrl = null
    try {
        ppUrl = await sock.profilePictureUrl(target, 'image')
    } catch {}
    
    const now = new Date()
    const timeStr = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
    
    let chatText = `â•­â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•®\n`
    chatText += `â”ƒ  ğŸ’¬ *á´¡Êœá´€á´›sá´€á´˜á´˜ á´„Êœá´€á´›*\n`
    chatText += `â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•¯\n\n`
    chatText += `â•­â”ˆâ”ˆâ¬¡ã€Œ ğŸ‘¤ *${targetName}* ã€\n`
    chatText += `â”ƒ ğŸ“± +${target.split('@')[0]}\n`
    chatText += `â”ƒ ğŸŸ¢ Online\n`
    chatText += `â•°â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ¬¡\n\n`
    
    chatText += `â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®\n`
    
    for (let i = 0; i < messages.length; i++) {
        const msg = messages[i]
        const isFromTarget = i % 2 === 0
        const msgTime = new Date(now.getTime() + (i * 60000))
        const msgTimeStr = msgTime.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
        
        if (isFromTarget) {
            chatText += `â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n`
            chatText += `â”‚ â”‚ ${msg}\n`
            chatText += `â”‚ â”‚        ${msgTimeStr} âœ“âœ“\n`
            chatText += `â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n`
        } else {
            chatText += `â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n`
            chatText += `â”‚        â”‚ ${msg}\n`
            chatText += `â”‚        â”‚        ${msgTimeStr} âœ“âœ“\n`
            chatText += `â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n`
        }
    }
    
    chatText += `â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯\n\n`
    chatText += `> ğŸ“… ${now.toLocaleDateString('id-ID')}\n`
    chatText += `> _Generated by ${config.bot?.name || 'Ourin-AI'}_`
    
    const saluranId = config.saluran?.id || '120363208449943317@newsletter'
    const saluranName = config.saluran?.name || config.bot?.name || 'Ourin-AI'
    
    const contextInfo = {
        forwardingScore: 9999,
        isForwarded: true,
        forwardedNewsletterMessageInfo: {
            newsletterJid: saluranId,
            newsletterName: saluranName,
            serverMessageId: 127
        }
    }
    
    if (ppUrl) {
        contextInfo.externalAdReply = {
            title: `Chat dengan ${targetName}`,
            body: messages[0].slice(0, 50),
            thumbnailUrl: ppUrl,
            mediaType: 1,
            renderLargerThumbnail: true
        }
    }
    
    await sock.sendMessage(m.chat, {
        text: chatText,
        contextInfo
    }, { quoted: m })
}

module.exports = {
    config: pluginConfig,
    handler
}
